---
title: "Supported Queries"
author: "Steven M. Mortimer"
date: "2020-07-10"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 4
    keep_md: true
vignette: >
  %\VignetteIndexEntry{Supported Queries}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
NOT_CRAN <- identical(tolower(Sys.getenv("NOT_CRAN")), "true")
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  purl = NOT_CRAN,
  eval = NOT_CRAN
)
```

## Supported Queries

The following vignette outlines the different types of queries that have been 
documented and tested. These are the "supported" query types that the **salesforcer** 
package currently handles. If you run into an issue, please submit [HERE](https://github.com/StevenMMortimer/salesforcer/issues/new?assignees=StevenMMortimer&labels=&template=query-issue-template.md&title=) 
in the GitHub repository so that we can fix or add your query type to this list. 
Thank you!
  
Note: SOQL is a powerful tool that allows you to return the fields of records in 
almost any object in Salesforce (e.g. standard objects like Accounts, Contacts, 
and Tasks, along with any custom objects and custom fields created in your Org. 
You are encouraged to use Bulk APIs when: 

  - You anticipate returning 10,000 records or more
  - Your query does not involve a parent-to-child nested relationship query
  - You would like to reduce the overall number of API calls to your Org
  
If you are not familiar with Salesforce's proprietary form of SQL called SOQL 
(Salesforce Object Query Language), please consider reading the following resources:

 - <a target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.soql_sosl.meta/soql_sosl/sforce_api_calls_soql_sosl_intro.htm">Introduction to SOQL and SOSL</a>  
 - <a target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.soql_sosl.meta/soql_sosl/sforce_api_calls_soql_select.htm">SOQL SELECT Syntax</a>  
 - <a target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.soql_sosl.meta/soql_sosl/sforce_api_calls_soql_relationships.htm">Relationship Queries</a>  
 - <a target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.soql_sosl.meta/soql_sosl/async_query_overview.htm">Async SOQL</a> 
 - <a target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.api_asynch.meta/api_asynch/asynch_api_bulk_query_intro.htm">Overview of queries in Bulk 1.0 API</a> 
 - <a target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.api_bulk_v2.meta/api_bulk_v2/queries.htm">Overview of queries in Bulk 2.0 API</a>

----  

## Examples
  
First, load the `salesforcer` package and login. There are two ways to authenticate: 
1) OAuth 2.0 and 2) Basic Username-Password. It is recommended to use OAuth 2.0 so that 
passwords do not have to be shared/embedded within scripts. User credentials will 
be stored in locally cached file entitled ".httr-oauth-salesforcer" in the current working 
directory.

```{r auth, include = FALSE}
suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(here)))
library(salesforcer)
token_path <- here::here("tests", "testthat", "salesforcer_token.rds")
suppressMessages(sf_auth(token = token_path, verbose = FALSE))
```

```{r load-package, eval=FALSE}
suppressWarnings(suppressMessages(library(dplyr)))
library(salesforcer)
sf_auth()
```

### Simple query

```{r query-records}
soql <- "SELECT Id,
                FirstName, 
                LastName
         FROM Contact
         LIMIT 10"

queried_records <- sf_query(soql) # REST API is the default api_type
queried_records

queried_records <- sf_query(soql, api_type = "SOAP")
queried_records
```

Note that the default API used for queries is the REST API. Every effort has been 
made so that the format of the results from the REST and SOAP APIs is exactly the 
same. The only difference will be speed. The REST API uses JSON, which can generally 
be processed more quickly than XML used in the SOAP API. Below is a small example 
to roughly demonstrate the magnitude of the performance difference between the 
REST and SOAP APIs.

```{r}
microbenchmark::microbenchmark(
  
)
```

```{r}
queried_records <- sf_query(soql)
queried_records
```

Note that the Bulk 1.0 API requires users to specify the target object along with 
their submitted SOQL. This is because it is needed when creating the bulk job that 
will manage and execute the query. The **salesforcer** package will try to infer 
the object in the query if not explicitly provided. If it does not guess correctly, 
then please specify

You'll notice that the `"Account.Name"` column does not appear in the results. This is 
because the SOAP and REST APIs do not return any Account information if it does not 
exist on the record and there is no reliable way to extract and rebuild the empty
columns based on the query string. If there were Account information, an
additional column titled `"Account.Name"` would appear in the results. Note, that 
the Bulk 1.0 and Bulk 2.0 APIs will return `"Account.Name"` as a column of all 
`NA` values for this query because they return results differently.

### Troubleshooting

If you are having an issue with a query please submit in the **salesforcer** GitHub 
repository at: <a target="_blank" href="https://github.com/StevenMMortimer/salesforcer/issues">https://github.com/StevenMMortimer/salesforcer/issues</a>. As a maintainer, queries are tough to debug because every Salesforce 
Org is unique. Custom objects or relationships created in your Salesforce Org may 
be different or even impossible to test in another Org. When filing your issue please 
make an attempt to understand the query and debug a little bit on your own. Here 
are a few suggestions:  

  1. Slightly modify your function call to `sf_query()` to observe the results. Here 
  are a few prompting questions that may assist you:  
  
    - What do you see when you set `verbose=TRUE` argument?
    - What happens if you change the `control` argument, specifically the batch size? 
    - What happens if you try using a different API e.g. ("SOAP" vs "REST" or "Bulk 1.0" vs "Bulk 2.0")
    - What happens if you change your query slightly? 
    - Do you need a parent-to-child nested relationship query or will a relationship lookup suffice? 
    
  2. Check out Salesforce's [Workbench](https://workbench.developerforce.com/login.php) 
  tool to see how it builds out queries.
  
  3. Review the unit test coverage for queries at: <a target="_blank" href="https://github.com/StevenMMortimer/salesforcer/blob/master/tests/testthat/test-query.R">https://github.com/StevenMMortimer/salesforcer/blob/master/tests/testthat/test-query.R</a>. 
  These unit tests were written to cover a variety of use cases and to track any 
  changes made between newly released versions of the Salesforce API (typically 
  4 each year). These tests are an excellent source of examples that may be 
  helpful in troubleshooting your own query.
  
  4. Roll up your sleeves and dive into the source code for the **salesforcer** 
  package. The main scripts to review are:  
  
    - <a target="_blank" href="https://github.com/StevenMMortimer/salesforcer/blob/master/R/query.R">https://github.com/StevenMMortimer/salesforcer/blob/master/R/query.R</a>
    - <a target="_blank" href="https://github.com/StevenMMortimer/salesforcer/blob/master/R/utils-query.R">https://github.com/StevenMMortimer/salesforcer/blob/master/R/utils-query.R</a>
