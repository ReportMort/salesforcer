---
title: "Supported Queries"
author: "Steven M. Mortimer"
date: "2020-07-10"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 4
    keep_md: true
vignette: >
  %\VignetteIndexEntry{Supported Queries}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
NOT_CRAN <- identical(tolower(Sys.getenv("NOT_CRAN")), "true")
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  purl = NOT_CRAN,
  eval = NOT_CRAN
)
```

First, load the `salesforcer` package and login. There are two ways to authenticate: 
1) OAuth 2.0 and 2) Basic Username-Password. It is recommended to use OAuth 2.0 so that 
passwords do not have to be shared/embedded within scripts. User credentials will 
be stored in locally cached file entitled ".httr-oauth-salesforcer" in the current working 
directory.

```{r auth, include = FALSE}
suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(here)))
library(salesforcer)
token_path <- here::here("tests", "testthat", "salesforcer_token.rds")
suppressMessages(sf_auth(token = token_path, verbose = FALSE))
```

```{r load-package, eval=FALSE}
suppressWarnings(suppressMessages(library(dplyr)))
library(salesforcer)
sf_auth()
```

### Query

Salesforce has proprietary form of SQL called SOQL (Salesforce Object Query
Language). SOQL is a powerful tool that allows you to return the fields of
records in almost any object in Salesforce including Accounts, Contacts, Tasks,
Opportunities, even Attachments! Below is an example where we grab the data we
just created including Account object information for which the Contact record
is associated with.

```{r query-records}
my_soql <- sprintf("SELECT Id, 
                           Account.Name, 
                           FirstName, 
                           LastName 
                    FROM Contact 
                    WHERE Id in ('%s')", 
                   paste0(created_records$id , collapse="','"))

queried_records <- sf_query(my_soql)
queried_records
```

You'll notice that the `"Account.Name"` column does not appear in the results. This is 
because the SOAP and REST APIs do not return any Account information if it does not 
exist on the record and there is no reliable way to extract and rebuild the empty
columns based on the query string. If there were Account information, an
additional column titled `"Account.Name"` would appear in the results. Note, that 
the Bulk 1.0 and Bulk 2.0 APIs will return `"Account.Name"` as a column of all 
`NA` values for this query because they return results differently.

### Troubleshooting

If you are having an issue with a query please submit an issue on the **salesforcer** 
GitHub repository at: <a target="_blank" href="https://github.com/StevenMMortimer/salesforcer/issues">https://github.com/StevenMMortimer/salesforcer/issues</a>. As a maintainer, queries are tough to debug because every Salesforce Org is unique. Custom objects or relationships created in your Salesforce Org may be 
different or even impossible to test in another Org. When filing your issue please 
make an attempt to understand the and debug yourself. In a couple ways: 

  1. Slightly modify your function call to `sf_query()` to observe the results. Here 
  are a few prompting questions that may assist you:  
  
    - What do you see when you set `verbose=TRUE` argument?
    - What happens if you change the `control` argument, specifically the batch size? 
    - What happens if you try using a different API e.g. ("SOAP" vs "REST" or "Bulk 1.0" vs "Bulk 2.0")
    - What happens if you change your query slightly? 
    - Do you need a parent-to-child nested relationship query or will a relationship lookup suffice? 
    
  2. Check out Salesforce's [Workbench](https://workbench.developerforce.com/login.php) 
  tool to see how it builds out queries.
  
  3. Review the unit test coverage for queries at: <a target="_blank" href="https://github.com/StevenMMortimer/salesforcer/blob/master/tests/testthat/test-query.R">https://github.com/StevenMMortimer/salesforcer/blob/master/tests/testthat/test-query.R</a>. 
  These unit tests were written to cover a variety of use cases and to track any 
  changes made between newly released versions of the Salesforce API (typically 
  4 each year). These tests are an excellent source of examples that may be 
  helpful in troubleshooting your own query.
  
  4. Roll up your sleeves and dive into the source code for the **salesforcer** 
  package. The main scripts to review are:  
  
    - <a target="_blank" href="https://github.com/StevenMMortimer/salesforcer/blob/master/R/query.R">https://github.com/StevenMMortimer/salesforcer/blob/master/R/query.R</a>
    - <a target="_blank" href="https://github.com/StevenMMortimer/salesforcer/blob/master/R/utils-query.R">https://github.com/StevenMMortimer/salesforcer/blob/master/R/utils-query.R</a>
